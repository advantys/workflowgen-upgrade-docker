parameters:
  - name: osVersion
    type: string
    default: ubuntu-18.04

steps:
  - task: Docker@2
    displayName: docker login
    inputs:
      command: login
      containerRegistry: Docker Hub Advantys
  - task: Docker@2
    displayName: Build and push image
    inputs:
      command: buildAndPush
      repository: advantys/workflowgen-upgrade
      containerRegistry: Docker Hub Advantys
      buildContext: $(Build.Repository.LocalPath)
      ${{ if contains(parameters.osVersion, 'ubuntu') }}:
        Dockerfile: $(Build.Repository.LocalPath)/linux/ubuntu/Dockerfile.linux
        tags: |
          ${{ variables.APP_VERSION }}-${{ parameters.osVersion }}
          latest-${{ parameters.osVersion }}
          latest
      ${{ if eq(parameters.osVersion, 'ltsc2019') }}:
        Dockerfile: $(Build.Repository.LocalPath)/windows/windowsservercore-${{ parameters.osVersion }}/Dockerfile.windows
        tags: |
          ${{ variables.APP_VERSION }}-win-${{ parameters.osVersion }}
          latest-win-${{ parameters.osVersion }}
  - task: Docker@2
    displayName: docker logout
    inputs:
      command: logout
      containerRegistry: Docker Hub Advantys
